name: "compliance_assessment_to_ocsf_compliance_finding"
input_schema: "azure_compliance_assessment"
output_schema: "ocsf_compliance_finding_v170"

# JSONPath expressions to extract data from Azure compliance assessment events
extractors:
  # Core Resource Fields
  event_id: "$.event_data.id"
  assessment_name: "$.event_data.name"
  resource_type: "$.event_data.type"
  tenant_id: "$.event_data.tenantId"
  
  # Assessment Details
  display_name: "$.event_data.properties.displayName"
  assessment_type: "$.event_data.properties.metadata.assessmentType"
  policy_definition_id: "$.event_data.properties.metadata.policyDefinitionId"
  description: "$.event_data.properties.metadata.description"
  severity: "$.event_data.properties.metadata.severity"
  categories: "$.event_data.properties.metadata.categories"
  
  # Status Information
  status_code: "$.event_data.properties.status.code"
  status_change_date: "$.event_data.properties.status.statusChangeDate"
  first_evaluation_date: "$.event_data.properties.status.firstEvaluationDate"
  
  # Resource Details
  resource_id: "$.event_data.properties.resourceDetails.id"
  resource_name: "$.event_data.properties.resourceDetails.resourceName"
  resource_provider: "$.event_data.properties.resourceDetails.resourceProvider"
  
  # Policy Initiatives
  policy_initiatives: "$.event_data.properties.statusPerInitiative"
  
  # Action and Timestamps
  action: "$.event_data.assessmentEventDataEnrichment.action"
  enrichment_timestamp: "$.event_data.assessmentEventDataEnrichment.timestamp"
  enqueued_time: "$.event_metadata.enqueued_time"
  processed_timestamp: "$.processing_metadata.processed_timestamp"
  
  # Subscription ID
  subscription_id: "$.event_data.id"

# OCSF v1.1.0-dev compliant template for Compliance Finding
template: |
  {
    "version": "1.1.0",
    "activity_id": 1,
    "activity_name": "Create",
    "category_uid": 2,
    "category_name": "Findings",
    "class_uid": 2003,
    "class_name": "Compliance Finding",
    "type_uid": 200301,
    "type_name": "Compliance Finding: Create",
    "time": {{ (extractors.status_change_date or extractors.first_evaluation_date or extractors.enrichment_timestamp or extractors.enqueued_time or extractors.processed_timestamp) | to_unix_timestamp_ms }},
    "time_dt": "{{ (extractors.status_change_date or extractors.first_evaluation_date or extractors.enrichment_timestamp or extractors.enqueued_time or extractors.processed_timestamp) | to_iso_string }}",
    "severity_id": {% if extractors.severity == "High" %}4{% elif extractors.severity == "Medium" %}3{% elif extractors.severity == "Low" %}2{% else %}1{% endif %},
    "severity": "{{ extractors.severity | default('Informational') }}",
    "status": "New",
    "status_id": 1,
    "cloud": {
      "provider": "Azure",
      "account": {
        "uid": "{{ extractors.subscription_id | extract_subscription_id }}",
        "type": "Azure Subscription",
        "type_id": 10
      },
      "region": "unknown"
    },
    "finding_info": {
      "uid": "{{ extractors.event_id }}",
      "title": "{{ extractors.display_name | default('Azure Policy Assessment') | json_escape | truncate(200) }}",
      "desc": "{{ extractors.description | default('Azure policy compliance assessment') | json_escape | truncate(500) }}",
      "types": ["Compliance"],
      "created_time": {{ (extractors.first_evaluation_date or extractors.status_change_date) | to_unix_timestamp_ms }},
      "product": {
        "name": "Azure Security Center",
        "vendor_name": "Microsoft",
        "version": "1.0"
      }
    },
    "compliance": {
      "standards": [{% if extractors.policy_initiatives %}{% for initiative in extractors.policy_initiatives %}"{{ initiative.policyInitiativeName | replace('\"', '\\\"') }}"{% if not loop.last %}, {% endif %}{% endfor %}{% else %}"Azure Policy Compliance"{% endif %}],
      "requirements": ["{{ extractors.policy_definition_id | default('Azure Policy Assessment') }}"],
      "status": "{{ extractors.status_code | default('Unknown') }}"
    },
    "resources": [
      {
        "uid": "{{ extractors.resource_id | default(extractors.event_id) }}",
        "name": "{{ extractors.resource_name | default('unknown') | truncate(100) }}",
        "type": "{{ extractors.resource_provider | default('Azure Resource') }}",
        "cloud_partition": "azure-commercial",
        "region": "unknown",
        "role_id": 3,
        "role": "Affected"
      }
    ],
    "metadata": {
      "version": "1.1.0",
      "product": {
        "name": "Azure Security Center",
        "vendor_name": "Microsoft",
        "version": "1.0"
      },
      "profiles": ["compliance"],
      "event_code": "azure_compliance_assessment",
      "original_time": {{ (extractors.status_change_date or extractors.first_evaluation_date) | to_unix_timestamp_ms }}
    },
    "raw_data": {{ azure_event | to_json }}
  }

# Custom filters for compliance assessment transformation
filters:
  json_escape: |
    def json_escape(text):
        if not text or not isinstance(text, str):
            return ''
        import json
        escaped = json.dumps(text)[1:-1]
        return escaped
  
  to_unix_timestamp_ms: |
    def to_unix_timestamp_ms(timestamp_str):
        from datetime import datetime
        if not timestamp_str:
            return int(datetime.utcnow().timestamp() * 1000)
        try:
            if timestamp_str.endswith('Z'):
                dt = datetime.fromisoformat(timestamp_str.replace('Z', '+00:00'))
            elif '+' in timestamp_str or '-' in timestamp_str[-6:]:
                dt = datetime.fromisoformat(timestamp_str)
            else:
                dt = datetime.fromisoformat(timestamp_str + '+00:00')
            return int(dt.timestamp() * 1000)
        except Exception:
            return int(datetime.utcnow().timestamp() * 1000)
  
  to_iso_string: |
    def to_iso_string(timestamp_str):
        """Convert timestamp to ISO 8601 string format for OpenSearch date fields"""
        from datetime import datetime
        if not timestamp_str:
            return datetime.utcnow().isoformat() + 'Z'
        try:
            if timestamp_str.endswith('Z'):
                dt = datetime.fromisoformat(timestamp_str.replace('Z', '+00:00'))
            elif '+' in timestamp_str or '-' in timestamp_str[-6:]:
                dt = datetime.fromisoformat(timestamp_str)
            else:
                dt = datetime.fromisoformat(timestamp_str + '+00:00')
            return dt.isoformat().replace('+00:00', 'Z')
        except Exception:
            return datetime.utcnow().isoformat() + 'Z'
  
  extract_subscription_id: |
    def extract_subscription_id(resource_id):
        if not resource_id or not isinstance(resource_id, str):
            return 'unknown'
        parts = resource_id.split('/')
        try:
            sub_index = parts.index('subscriptions')
            if sub_index + 1 < len(parts):
                return parts[sub_index + 1]
        except (ValueError, IndexError):
            pass
        return 'unknown'
  
  truncate: |
    def truncate(text, length=100):
        if not text or not isinstance(text, str):
            return ''
        return text[:length] if len(text) > length else text