name: "security_assessment_to_asff"
input_schema: "azure_security_assessment"
output_schema: "asff_vulnerability_finding"

# JSONPath extractors for Azure Security Assessment data
extractors:
  # Core Assessment Fields
  assessment_id: "$.event_data.id"
  assessment_name: "$.event_data.properties.displayName"
  assessment_description: "$.event_data.properties.description"
  assessment_type: "$.event_data.type"
  
  # Vulnerability Information  
  cve_id: "$.event_data.properties.metadata.cve"
  severity: "$.event_data.properties.status.severity"
  status: "$.event_data.properties.status.code"
  
  # Time Information
  time_generated: "$.event_data.properties.timeGenerated"
  
  # Resource Information
  resource_id: "$.event_data.properties.resourceDetails.id"
  resource_type: "$.event_data.properties.resourceDetails.type"
  
  # Remediation
  remediation_description: "$.event_data.properties.metadata.remediationDescription"
  
  # Threat Information
  threat: "$.event_data.properties.metadata.threat"
  category: "$.event_data.properties.metadata.category"
  
  # Azure Subscription
  subscription_id: "$.event_data.properties.resourceDetails.sourceResourceId"
  
  # Compliance & Standards
  policy_definition_id: "$.event_data.properties.metadata.policyDefinitionId"

# ASFF template for vulnerability findings
template: |
  {
    "SchemaVersion": "2018-10-08",
    "Id": "{{ extractors.assessment_id | default(generate_uuid()) }}",
    "ProductArn": "arn:aws:securityhub:{{ aws_region }}:{{ aws_account_id }}:product/{{ aws_account_id }}/default",
    "ProductName": "{{ config.asff_product_name | default('Microsoft Defender - Security Assessment') }}",
    "CompanyName": "Microsoft",
    "GeneratorId": "azure-security-assessment",
    "AwsAccountId": "{{ aws_account_id }}",
    "Types": ["Software and Configuration Checks/Vulnerabilities"],
    "FirstObservedAt": "{{ extractors.time_generated | normalize_timestamp }}",
    "CreatedAt": "{{ extractors.time_generated | normalize_timestamp }}",
    "UpdatedAt": "{{ extractors.time_generated | normalize_timestamp }}",
    "Severity": {
      "Label": "{{ extractors.severity | asff_severity_label }}",
      "Normalized": {{ extractors.severity | asff_severity_normalized }}
    },
    "Title": "{{ extractors.assessment_name | default('Azure Security Assessment') | truncate(200) }}",
    "Description": "{{ extractors.assessment_description | default('No description available') | truncate(1024) }}",
    "Remediation": {
      "Recommendation": {
        "Text": "{{ extractors.remediation_description | default('Review and remediate the security finding') | replace('"', '\\"') | replace('\n', ' ') | truncate(512) }}",
        "Url": "https://portal.azure.com/#blade/Microsoft_Azure_Security/RecommendationsBlade"
      }
    },
    "ProductFields": {
      "azure/assessmentType": "{{ extractors.assessment_type | default('Security') }}",
      "azure/status": "{{ extractors.status | default('Unknown') }}",
      "azure/category": "{{ extractors.category | default('Unknown') }}",
      "azure/subscriptionId": "{{ extractors.resource_id | extract_subscription_id | default('Unknown') }}",
      "azure/cveId": "{{ extractors.cve_id | default('') }}",
      "aws/securityhub/ProductName": "{{ config.asff_product_name | default('Microsoft Defender - Security Assessment') }}",
      "aws/securityhub/CompanyName": "Microsoft"
    },
    "Resources": [{
      "Type": "Other",
      "Id": "{{ extractors.resource_id | default('Unknown') }}",
      "Partition": "aws",
      "Region": "{{ extractors.resource_id | extract_azure_region | default('unknown') }}",
      "Details": {
        "Other": {
          "AzureResourceId": "{{ extractors.resource_id | default('') }}",
          "ResourceType": "{{ extractors.resource_type | default('Azure Resource') }}"
        }
      }
    }],
    "WorkflowState": "NEW",
    "RecordState": "{{ extractors.status | asff_record_state }}"
  }