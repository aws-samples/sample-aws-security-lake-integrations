# 2025 Amazon Web Services, Inc. or its affiliates. All Rights Reserved.
# This AWS Content is provided subject to the terms of the AWS Customer Agreement available at
# http://aws.amazon.com/agreement or other written agreement between Customer and either
# Amazon Web Services, Inc. or Amazon Web Services EMEA SARL or both.

name: "azure_syslog_to_ocsf_process_activity"
input_schema: "azure_syslog_logs"
output_schema: "ocsf_process_activity_v110"

# JSONPath extractors for Azure Syslog (records already unpacked individually)
extractors:
  # Core identification - accessing individual unpacked record
  computer: "$.event_data.Computer"
  event_time: "$.event_data.EventTime"
  time_generated: "$.event_data.TimeGenerated"
  facility: "$.event_data.Facility"
  host_ip: "$.event_data.HostIP"
  host_name: "$.event_data.HostName"
  
  # Process information
  process_id: "$.event_data.ProcessID"
  process_name: "$.event_data.ProcessName"
  syslog_message: "$.event_data.SyslogMessage"
  severity_level: "$.event_data.SeverityLevel"
  source_system: "$.event_data.SourceSystem"
  
  # Azure metadata
  resource_id: "$.event_data._ResourceId"
  subscription_id: "$.event_data._SubscriptionId"
  tenant_id: "$.event_data.TenantId"
  item_id: "$.event_data._ItemId"
  
  # Processing metadata
  processed_timestamp: "$.processing_metadata.processed_timestamp"
  processor_version: "$.processing_metadata.processor_version"
  eventhub_name: "$.processing_metadata.eventhub_name"

# OCSF v1.1.0 Process Activity template (class_uid: 1007)
template: |
  {
    "version": "1.1.0",
    "class_uid": 1007,
    "class_name": "Process Activity",
    "category_uid": 1,
    "category_name": "System Activity",
    "activity_id": 99,
    "activity_name": "Other",
    "type_uid": 100799,
    "type_name": "Process Activity: Other",
    "time": {{ extractors.time_generated | to_unix_timestamp_ms }},
    "severity_id": {{ extractors.severity_level | map_syslog_severity_id }},
    "severity": "{{ extractors.severity_level | map_syslog_severity }}",
    "status": "Success",
    "status_id": 1,
    "message": "{{ extractors.syslog_message | truncate_message | json_escape }}",
    "process": {
      "name": "{{ extractors.process_name }}",
      "pid": {{ extractors.process_id | default(0) | int }},
      "cmd_line": "{{ extractors.syslog_message | extract_command_line | json_escape }}"
    },
    "actor": {
      "process": {
        "name": "{{ extractors.process_name }}",
        "pid": {{ extractors.process_id | default(0) | int }}
      }
    },
    "device": {
      "name": "{{ extractors.computer }}",
      "hostname": "{{ extractors.host_name }}",
      "ip": "{{ extractors.host_ip }}",
      "type": "{{ extractors.source_system }}",
      "type_id": 99,
      "os": {
        "name": "{{ extractors.source_system }}",
        "type": "{{ extractors.source_system }}",
        "type_id": 100
      },
      "uid": "{{ extractors.resource_id }}"
    },
    "metadata": {
      "version": "1.1.0",
      "product": {
        "name": "Azure Monitor",
        "vendor_name": "Microsoft",
        "feature": {
          "name": "Syslog"
        }
      },
      "profiles": ["cloud", "host"],
      "uid": "{{ extractors.item_id }}",
      "logged_time": {{ extractors.time_generated | to_unix_timestamp_ms }},
      "processed_time": {{ extractors.processed_timestamp | to_unix_timestamp_ms }}
    },
    "cloud": {
      "provider": "Azure",
      "account": {
        "uid": "{{ extractors.subscription_id }}",
        "type": "Azure Subscription",
        "type_id": 10
      }
    },
    "observables": [
      {
        "name": "facility",
        "type": "Syslog Facility",
        "type_id": 99,
        "value": "{{ extractors.facility }}"
      }
    ],
    "unmapped": {
      "tenant_id": "{{ extractors.tenant_id }}",
      "eventhub_name": "{{ extractors.eventhub_name }}",
      "processor_version": "{{ extractors.processor_version }}",
      "facility": "{{ extractors.facility }}",
      "source_system": "{{ extractors.source_system }}"
    }
  }

# Custom filters for Azure Syslog
filters:
  to_unix_timestamp_ms: |
    def to_unix_timestamp_ms(timestamp_str):
        from datetime import datetime
        if not timestamp_str:
            return int(datetime.utcnow().timestamp() * 1000)
        try:
            # Handle ISO 8601 formats
            if isinstance(timestamp_str, list):
                timestamp_str = timestamp_str[0] if timestamp_str else None
            if not timestamp_str:
                return int(datetime.utcnow().timestamp() * 1000)
            if isinstance(timestamp_str, str):
                if timestamp_str.endswith('Z'):
                    dt = datetime.fromisoformat(timestamp_str.replace('Z', '+00:00'))
                elif '+' in timestamp_str or timestamp_str.count('-') > 2:
                    dt = datetime.fromisoformat(timestamp_str)
                else:
                    dt = datetime.fromisoformat(timestamp_str + '+00:00')
                return int(dt.timestamp() * 1000)
            return int(datetime.utcnow().timestamp() * 1000)
        except Exception:
            return int(datetime.utcnow().timestamp() * 1000)
  
  map_syslog_severity_id: |
    def map_syslog_severity_id(severity):
        if not severity:
            return 1
        severity_map = {
            'emerg': 6,      # Emergency -> Fatal
            'alert': 5,      # Alert -> Critical
            'crit': 5,       # Critical -> Critical
            'err': 4,        # Error -> High
            'error': 4,      # Error -> High
            'warning': 3,    # Warning -> Medium
            'warn': 3,       # Warning -> Medium
            'notice': 2,     # Notice -> Low
            'info': 1,       # Informational -> Informational
            'debug': 1       # Debug -> Informational
        }
        return severity_map.get(str(severity).lower(), 1)
  
  map_syslog_severity: |
    def map_syslog_severity(severity):
        if not severity:
            return 'Informational'
        severity_map = {
            'emerg': 'Fatal',
            'alert': 'Critical',
            'crit': 'Critical',
            'err': 'High',
            'error': 'High',
            'warning': 'Medium',
            'warn': 'Medium',
            'notice': 'Low',
            'info': 'Informational',
            'debug': 'Informational'
        }
        return severity_map.get(str(severity).lower(), 'Informational')
  
  truncate_message: |
    def truncate_message(message):
        if not message or not isinstance(message, str):
            return ''
        # Truncate to 1000 characters for readability
        return message[:1000] if len(message) > 1000 else message
  
  extract_command_line: |
    def extract_command_line(message):
        if not message or not isinstance(message, str):
            return ''
        # Extract first 200 chars as potential command line
        return message[:200] if len(message) > 200 else message
  
  json_escape: |
    def json_escape(text):
        if not text or not isinstance(text, str):
            return ''
        import json
        try:
            escaped = json.dumps(text)[1:-1]
            return escaped
        except Exception:
            return str(text).replace('"', '\\"').replace('\n', '\\n').replace('\r', '\\r')