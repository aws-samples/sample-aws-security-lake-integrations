name: "generic_to_cloudtrail"
input_schema: "azure_generic_event"
output_schema: "cloudtrail_audit_event"

# JSONPath expressions to extract data from generic Azure events
extractors:
  event_id: "$.event_data.id"
  resource_type: "$.event_data.type"
  resource_name: "$.event_data.name"
  time_generated: "$.event_data.TimeGenerated"
  time_generated_alt: "$.event_data.timeGenerated"
  timestamp_field: "$.event_data.timestamp"
  event_time: "$.event_data.eventTime"
  processed_timestamp: "$.processing_metadata.processed_timestamp"
  enqueued_time: "$.event_metadata.enqueued_time"
  subscription_info: "$.event_data.id"

# Jinja2 template for CloudTrail Lake integration format
template: |
  {
    "eventData": {
      "version": "1.0",
      "userIdentity": {
        "type": "AzureService",
        "principalId": "azure-service",
        "details": {
          "resourceType": "{{ extractors.resource_type | default('Azure::Generic') }}",
          "integrationVersion": "4.0.0"
        }
      },
      "eventSource": "{{ config.event_source }}",
      "eventName": "{{ config.event_name_prefix }}",
      "eventTime": "{{ extractors.time_generated or extractors.time_generated_alt or extractors.timestamp_field or extractors.event_time or extractors.processed_timestamp or extractors.enqueued_time or timestamp | normalize_timestamp }}",
      "UID": "{{ generate_uuid() }}",
      "recipientAccountId": "{{ aws_account_id }}",
      "userAgent": "{{ config.user_agent }}",
      "additionalEventData": {
        "resourceId": "{{ extractors.event_id | default('unknown') }}",
        "resourceType": "{{ extractors.resource_type | default('Azure::Generic') }}",
        "resourceName": "{{ extractors.resource_name | default('unknown') }}",
        "originalEventData": {{ azure_event.event_data | to_json }},
        "ocsf_class": "{{ config.ocsf_class }}",
        "originalEventSource": "Azure Services",
        "processingTimestamp": "{{ timestamp | normalize_timestamp }}"
      }
    },
    "id": "{{ generate_uuid() }}"
  }