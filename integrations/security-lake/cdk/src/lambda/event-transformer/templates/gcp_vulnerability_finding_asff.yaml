name: "gcp_vulnerability_to_asff"
input_schema: "gcp_scc_finding"
output_schema: "asff_vulnerability_finding"

# JSONPath extractors for GCP SCC Vulnerability Finding fields
extractors:
  # Core Finding Fields
  finding_name: "$.event_data.finding.name"
  finding_id: "$.event_data.finding.name"
  parent: "$.event_data.finding.parent"
  resource_name: "$.event_data.finding.resourceName"
  state: "$.event_data.finding.state"
  category: "$.event_data.finding.category"
  external_uri: "$.event_data.finding.externalUri"
  
  # Timestamps
  event_time: "$.event_data.finding.eventTime"
  create_time: "$.event_data.finding.createTime"
  
  # Severity
  severity: "$.event_data.finding.severity"
  
  # Vulnerability Specific
  cve_id: "$.event_data.finding.vulnerability.cve.id"
  cvss_score: "$.event_data.finding.vulnerability.cve.cvssv3.baseScore"
  cvss_severity: "$.event_data.finding.vulnerability.cve.cvssv3.baseSeverity"
  cvss_vector: "$.event_data.finding.vulnerability.cve.cvssv3.attackVector"
  references: "$.event_data.finding.vulnerability.cve.references"
  upstream_fix_available: "$.event_data.finding.vulnerability.cve.upstreamFixAvailable"
  
  # GCP Resource Information
  project_id: "$.event_data.finding.resourceName"
  project_display_name: "$.event_data.resource.projectDisplayName"
  resource_type: "$.event_data.resource.type"
  resource_display_name: "$.event_data.resource.displayName"
  
  # Finding Class
  finding_class: "$.event_data.finding.findingClass"
  
  # Description
  description: "$.event_data.finding.description"
  recommendation: "$.event_data.finding.recommendation"

# ASFF template for GCP Vulnerability Finding
template: |
  {
    "SchemaVersion": "2018-10-08",
    "Id": "{{ extractors.finding_id | extract_finding_uid }}",
    "ProductArn": "arn:aws:securityhub:{{ aws_region }}:{{ aws_account_id }}:product/{{ aws_account_id }}/default",
    "ProductName": "{{ config.asff_product_name | default('Google Cloud Security Command Center') }}",
    "CompanyName": "Google",
    "GeneratorId": "gcp-scc-vulnerability",
    "AwsAccountId": "{{ aws_account_id }}",
    "Types": ["Software and Configuration Checks/Vulnerabilities/CVE"],
    "FirstObservedAt": "{{ extractors.event_time | default(extractors.create_time) | normalize_timestamp }}",
    "CreatedAt": "{{ extractors.create_time | default(extractors.event_time) | normalize_timestamp }}",
    "UpdatedAt": "{{ extractors.create_time | default(extractors.event_time) | normalize_timestamp }}",
    "Severity": {
      "Label": "{{ extractors.severity | gcp_to_asff_severity_label }}",
      "Normalized": {{ extractors.severity | gcp_to_asff_severity_normalized }}{% if extractors.cvss_score %},
      "Product": {{ extractors.cvss_score }}{% endif %}
    },
    "FindingProviderFields": {
      "Types": ["Software and Configuration Checks/Vulnerabilities/CVE"],
      "Severity": {
        "Label": "{{ extractors.severity | gcp_to_asff_severity_label }}",
        "Original": "{{ extractors.severity | upper }}"
      }
    },
    "Title": "{{ extractors.category | default('GCP Vulnerability Finding') | truncate(200) }}{% if extractors.cve_id %}: {{ extractors.cve_id }}{% endif %}",
    "Description": "{{ extractors.description | default(extractors.category) | default('Vulnerability detected in GCP resource') | truncate(1024) }}",{% if extractors.recommendation or extractors.external_uri %}
    "Remediation": {
      "Recommendation": {
        "Text": "{{ extractors.recommendation | default('Review and remediate the vulnerability according to GCP Security Command Center recommendations') | truncate(400) }}",
        "Url": "{{ extractors.external_uri | default('https://console.cloud.google.com/security/command-center') }}"
      }
    },{% endif %}{% if extractors.external_uri %}
    "SourceUrl": "{{ extractors.external_uri }}",{% endif %}
    "ProductFields": {
      "gcp/findingClass": "{{ extractors.finding_class | default('VULNERABILITY') }}",
      "gcp/category": "{{ extractors.category | default('') }}",
      "gcp/projectId": "{{ extractors.project_id | extract_gcp_project_id }}",{% if extractors.project_display_name %}
      "gcp/projectDisplayName": "{{ extractors.project_display_name }}",{% endif %}{% if extractors.cvss_vector %}
      "gcp/cvssAttackVector": "{{ extractors.cvss_vector }}",{% endif %}{% if extractors.cvss_severity %}
      "gcp/cvssSeverity": "{{ extractors.cvss_severity }}",{% endif %}{% if extractors.upstream_fix_available %}
      "gcp/upstreamFixAvailable": "{{ extractors.upstream_fix_available }}",{% endif %}
      "gcp/state": "{{ extractors.state | default('ACTIVE') }}",
      "aws/securityhub/FindingId": "arn:aws:securityhub:{{ aws_region }}:{{ aws_account_id }}:product/{{ aws_account_id }}/default/{{ extractors.finding_id | extract_finding_uid }}",
      "aws/securityhub/ProductName": "{{ config.asff_product_name | default('Google Cloud Security Command Center') }}",
      "aws/securityhub/CompanyName": "Google"
    },{% if extractors.cve_id %}
    "Vulnerabilities": [{
      "Id": "{{ extractors.cve_id }}",{% if extractors.cvss_score %}
      "Cvss": [{
        "Version": "3.0",
        "BaseScore": {{ extractors.cvss_score }}{% if extractors.cvss_vector %},
        "BaseVector": "{{ extractors.cvss_vector }}"{% endif %}{% if extractors.cvss_severity %},
        "BaseSeverity": "{{ extractors.cvss_severity | upper }}"{% endif %}
      }],{% endif %}{% if extractors.references %}
      "ReferenceUrls": {{ extractors.references | to_json }},{% endif %}{% if extractors.upstream_fix_available %}
      "FixAvailable": "YES",{% endif %}
      "VulnerablePackages": [{
        "Name": "{{ extractors.resource_display_name | default(extractors.resource_name | extract_resource_name) | default('Unknown') }}",
        "Version": "Unknown"
      }]
    }],{% endif %}
    "Resources": [{
      "Type": "{% if extractors.resource_type %}{{ extractors.resource_type }}{% else %}Other{% endif %}",
      "Id": "{{ extractors.resource_name }}",
      "Partition": "aws",
      "Region": "{{ extractors.resource_name | extract_gcp_region }}",
      "Details": {
        "Other": {
          "GcpResourceName": "{{ extractors.resource_name }}",
          "GcpResourceDisplayName": "{{ extractors.resource_display_name | default('') }}",
          "GcpResourceType": "{{ extractors.resource_type | default('') }}",
          "GcpProjectId": "{{ extractors.project_id | extract_gcp_project_id }}"
        }
      }
    }],
    "Workflow": {"Status": "NEW"},
    "Region": "{{ aws_region }}",
    "WorkflowState": "NEW",
    "RecordState": "{{ extractors.state | gcp_state_to_asff_record_state }}"
  }

# Custom filters for GCP-to-ASFF transformations
filters:
  extract_finding_uid: |
    def extract_finding_uid(finding_name):
        if not finding_name:
            return ''
        parts = finding_name.split('/')
        if len(parts) > 0:
            return parts[-1]
        return finding_name
  
  extract_gcp_project_id: |
    def extract_gcp_project_id(resource_name):
        if not resource_name:
            return ''
        if 'projects/' in resource_name:
            parts = resource_name.split('projects/')
            if len(parts) > 1:
                return parts[1].split('/')[0]
        return ''
  
  extract_gcp_region: |
    def extract_gcp_region(resource_name):
        if not resource_name:
            return 'global'
        if '/locations/' in resource_name:
            parts = resource_name.split('/locations/')
            if len(parts) > 1:
                return parts[1].split('/')[0]
        return 'global'
  
  extract_resource_name: |
    def extract_resource_name(resource_path):
        if not resource_path:
            return ''
        parts = resource_path.split('/')
        if len(parts) > 0:
            return parts[-1]
        return resource_path
  
  gcp_to_asff_severity_label: |
    def gcp_to_asff_severity_label(severity):
        severity_map = {
            'CRITICAL': 'CRITICAL',
            'HIGH': 'HIGH',
            'MEDIUM': 'MEDIUM',
            'LOW': 'LOW',
            'UNSPECIFIED': 'INFORMATIONAL'
        }
        return severity_map.get(str(severity).upper(), 'INFORMATIONAL')
  
  gcp_to_asff_severity_normalized: |
    def gcp_to_asff_severity_normalized(severity):
        severity_map = {
            'CRITICAL': 90,
            'HIGH': 70,
            'MEDIUM': 40,
            'LOW': 10,
            'UNSPECIFIED': 0
        }
        return severity_map.get(str(severity).upper(), 0)
  
  gcp_state_to_asff_record_state: |
    def gcp_state_to_asff_record_state(state):
        state_map = {
            'ACTIVE': 'ACTIVE',
            'INACTIVE': 'ARCHIVED'
        }
        return state_map.get(str(state).upper(), 'ACTIVE')
  
  normalize_timestamp: |
    def normalize_timestamp(timestamp_str):
        if not timestamp_str:
            return datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%S.%fZ')
        try:
            if timestamp_str.endswith('Z'):
                return timestamp_str
            elif '+' in timestamp_str or timestamp_str[-6] == '-':
                dt = datetime.fromisoformat(timestamp_str)
                return dt.strftime('%Y-%m-%dT%H:%M:%S.%fZ')
            else:
                return timestamp_str + 'Z'
        except:
            return datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%S.%fZ')
  
  truncate: |
    def truncate(text, length):
        if not text:
            return ''
        text = str(text)
        return text[:length] + '...' if len(text) > length else text
  
  to_json: |
    def to_json(data):
        if not data:
            return '[]'
        try:
            return json.dumps(data)
        except:
            return '[]'